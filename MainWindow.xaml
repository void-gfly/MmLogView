<Window x:Class="MmLogView.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:controls="clr-namespace:MmLogView.Controls"
        xmlns:mdxam="clr-namespace:MdXaml;assembly=MdXaml"
        xmlns:properties="clr-namespace:MmLogView.Properties"
        Title="MmLogView"
        Width="1200" Height="800"
        MinWidth="600" MinHeight="400"
        WindowStartupLocation="CenterScreen"
        AllowDrop="True"
        Drop="Window_Drop"
        DragOver="Window_DragOver"
        Background="{DynamicResource WindowBackground}"
        Foreground="{DynamicResource WindowForeground}"
        KeyDown="Window_KeyDown">

    <Window.InputBindings>
        <KeyBinding Gesture="Ctrl+O" Command="{Binding OpenFileCommand}" />
        <KeyBinding Gesture="Ctrl+G" Command="{Binding GoToLineCommand}" />
        <KeyBinding Gesture="Ctrl+F" Command="{Binding ToggleSearchCommand}" />
    </Window.InputBindings>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />  <!-- Toolbar -->
            <RowDefinition Height="Auto" />  <!-- Search bar -->
            <RowDefinition Height="*" />     <!-- Log viewport -->
            <RowDefinition Height="Auto" />  <!-- Status bar -->
        </Grid.RowDefinitions>

        <!-- Toolbar -->
        <Border Grid.Row="0" 
                Background="{DynamicResource ToolbarBackground}" 
                BorderBrush="{DynamicResource BorderBrush}" 
                BorderThickness="0,0,0,1"
                Padding="8,4">
            <DockPanel LastChildFill="True">
                <StackPanel DockPanel.Dock="Left" Orientation="Horizontal">
                    <!-- Split Button: æ‰“å¼€ + æœ€è¿‘æ–‡ä»¶ä¸‹æ‹‰ -->
                    <Grid Margin="0,0,8,0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        <Button Grid.Column="0"
                                Content="{Binding Source={x:Static properties:ResourcesExtension.Instance}, Path=BtnOpen}" 
                                Command="{Binding OpenFileCommand}"
                                Style="{DynamicResource ToolbarButton}" />
                        <Button x:Name="RecentDropdownBtn" Grid.Column="1"
                                Content="â–¾"
                                Style="{DynamicResource ToolbarButton}"
                                Padding="4,5"
                                Click="RecentDropdownBtn_Click">
                            <Button.ContextMenu>
                                <ContextMenu x:Name="RecentFilesMenu"
                                             ItemsSource="{Binding RecentFiles}"
                                             Placement="Bottom">
                                    <ContextMenu.ItemContainerStyle>
                                        <Style TargetType="MenuItem" BasedOn="{StaticResource {x:Type MenuItem}}">
                                            <Setter Property="Command" Value="{Binding DataContext.OpenRecentFileCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" />
                                            <Setter Property="CommandParameter" Value="{Binding}" />
                                        </Style>
                                    </ContextMenu.ItemContainerStyle>
                                </ContextMenu>
                            </Button.ContextMenu>
                        </Button>
                    </Grid>
                    <Button Content="{Binding Source={x:Static properties:ResourcesExtension.Instance}, Path=BtnSearch}" 
                            Command="{Binding ToggleSearchCommand}"
                            Style="{DynamicResource ToolbarButton}"
                            Margin="0,0,8,0" />
                    <Button Content="{Binding Source={x:Static properties:ResourcesExtension.Instance}, Path=BtnGoTo}" 
                            Command="{Binding GoToLineCommand}"
                            Style="{DynamicResource ToolbarButton}"
                            Margin="0,0,8,0" />
                </StackPanel>
                <StackPanel DockPanel.Dock="Right" Orientation="Horizontal">
                    <ComboBox ItemsSource="{Binding LanguageItems}"
                              SelectedIndex="{Binding SelectedLanguageIndex}"
                              Width="80"
                              VerticalAlignment="Center"
                              Margin="0,0,8,0" />
                    <Button Content="ðŸŒ™" 
                            Command="{Binding ToggleThemeCommand}"
                            Style="{DynamicResource ToolbarButton}"
                            ToolTip="{Binding Source={x:Static properties:ResourcesExtension.Instance}, Path=ThemeTooltip}" />
                </StackPanel>
                <TextBlock Text="{Binding Source={x:Static properties:ResourcesExtension.Instance}, Path=FeatureText}"
                           Foreground="{DynamicResource DimForeground}"
                           VerticalAlignment="Center"
                           HorizontalAlignment="Center"
                           FontSize="12"
                           Opacity="0.7" />
            </DockPanel>
        </Border>

        <!-- Search bar (collapsed by default) -->
        <Border Grid.Row="1" 
                Background="{DynamicResource ToolbarBackground}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="0,0,0,1"
                Padding="8,4"
                Visibility="{Binding IsSearchVisible, Converter={StaticResource BoolToVisibility}}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <TextBox Grid.Column="0"
                         Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                         Style="{DynamicResource SearchTextBox}"
                         x:Name="SearchBox"
                         KeyDown="SearchBox_KeyDown" />
                <TextBlock Grid.Column="1"
                           Text="{Binding SearchResultInfo}"
                           Foreground="{DynamicResource DimForeground}"
                           VerticalAlignment="Center"
                           Margin="8,0" />
                <Button Grid.Column="2" Content="â–²" 
                        Command="{Binding SearchPrevCommand}"
                        Style="{DynamicResource ToolbarButton}"
                        Margin="0,0,4,0" />
                <Button Grid.Column="3" Content="â–¼" 
                        Command="{Binding SearchNextCommand}"
                        Style="{DynamicResource ToolbarButton}" />
            </Grid>
        </Border>

        <!-- Log viewport (visible in Log mode) -->
        <controls:LogViewport Grid.Row="2"
                              x:Name="LogView"
                              Visibility="{Binding IsLogMode, Converter={StaticResource BoolToVisibility}}" />

        <!-- Markdown viewer (visible when in Markdown mode) -->
        <mdxam:MarkdownScrollViewer Grid.Row="2"
                                    x:Name="MdViewer"
                                    MarkdownStyle="{x:Static mdxam:MarkdownStyle.Sasabune}"
                                    Markdown="{Binding MarkdownText}"
                                    Background="{DynamicResource MarkdownBackground}"
                                    Foreground="{DynamicResource MarkdownForeground}"
                                    Padding="20"
                                    VerticalScrollBarVisibility="Auto"
                                    Visibility="{Binding IsMarkdownMode, Converter={StaticResource BoolToVisibility}}" />

        <!-- Json viewport (visible when in Json mode) -->
        <controls:JsonViewport Grid.Row="2"
                               x:Name="JsonView"
                               Visibility="{Binding IsJsonMode, Converter={StaticResource BoolToVisibility}}" />

        <!-- Status bar -->
        <Border Grid.Row="3" 
                Background="{DynamicResource StatusBarBackground}" 
                BorderBrush="{DynamicResource BorderBrush}" 
                BorderThickness="0,1,0,0"
                Padding="8,3">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <TextBlock Grid.Column="0" 
                           Text="{Binding StatusText}" 
                           Foreground="{DynamicResource StatusBarForeground}"
                           VerticalAlignment="Center" />
                <TextBlock Grid.Column="1" 
                           Text="{Binding EncodingText}" 
                           Foreground="{DynamicResource StatusBarForeground}"
                           VerticalAlignment="Center"
                           Margin="16,0" />
                <TextBlock Grid.Column="2" 
                           Text="{Binding FileSizeText}" 
                           Foreground="{DynamicResource StatusBarForeground}"
                           VerticalAlignment="Center"
                           Margin="16,0" />
                <TextBlock Grid.Column="3" 
                           Text="{Binding LineInfoText}" 
                           Foreground="{DynamicResource StatusBarForeground}"
                           VerticalAlignment="Center"
                           Margin="16,0" />
                <ProgressBar Grid.Column="4"
                             Width="100" Height="12"
                             Minimum="0" Maximum="100"
                             Value="{Binding ScanProgress}"
                             Visibility="{Binding IsScanningVisible, Converter={StaticResource BoolToVisibility}}"
                             Margin="16,0,0,0" />
            </Grid>
        </Border>
    </Grid>
</Window>
